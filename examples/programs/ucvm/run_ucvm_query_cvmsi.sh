#!/bin/bash

if [ -z "$UCVM_INSTALL_PATH" ]; then
  echo "Need to set UCVM_INSTALL_PATH to run >" ${0##*/} 
  exit
fi
source $UCVM_INSTALL_PATH/conf/ucvm_env.sh

BIN_DIR=${UCVM_INSTALL_PATH}/bin
CONF_DIR=${UCVM_INSTALL_PATH}/conf
TEST_DIR=${UCVM_INSTALL_PATH}/tests/inputs
MODEL=cvmsi

expect=$(mktemp) || exit 1
result=$(mktemp) || (trap 'rm -f "$expect"'; exit 1)

${BIN_DIR}/ucvm_query -m ${MODEL} -f ${CONF_DIR}/ucvm.conf < ${TEST_DIR}/test_latlons_cvmsi.txt  > $result 2>&1

cat > $expect << EOF_EXPECTED_RESULT
Using Geo Depth coordinates as default mode.
 -118.4830    34.2940   1000.000    353.889    390.625      cvmsi   2535.884   1345.005   2275.284       none      0.000      0.000      0.000      crust   2535.884   1345.005   2275.284
 -118.4830    34.2940   3000.000    353.889    390.625      cvmsi   3636.559   2239.384   2407.746       none      0.000      0.000      0.000      crust   3636.559   2239.384   2407.746
 -118.4830    34.2940   5000.000    353.889    390.625      cvmsi   4766.278   2824.604   2551.714       none      0.000      0.000      0.000      crust   4766.278   2824.604   2551.714
 -118.4050    34.3580   1000.000    947.410    710.100      cvmsi   5238.029   2767.287   2745.227       none      0.000      0.000      0.000      crust   5238.029   2767.287   2745.227
 -118.4050    34.3580   3000.000    947.410    710.100      cvmsi   5807.036   3235.216   2723.316       none      0.000      0.000      0.000      crust   5807.036   3235.216   2723.316
 -118.4050    34.3580   5000.000    947.410    710.100      cvmsi   6150.872   3388.498   2701.404       none      0.000      0.000      0.000      crust   6150.872   3388.498   2701.404
 -118.4440    34.3260   1000.000    444.266    361.893      cvmsi   2551.620   1375.176   2270.562       none      0.000      0.000      0.000      crust   2551.620   1375.176   2270.562
 -118.4440    34.3260   3000.000    444.266    361.893      cvmsi   3460.766   2116.687   2348.532       none      0.000      0.000      0.000      crust   3460.766   2116.687   2348.532
 -118.4440    34.3260   5000.000    444.266    361.893      cvmsi   4237.484   2513.069   2418.405       none      0.000      0.000      0.000      crust   4237.484   2513.069   2418.405
 -118.4167    34.3489   1000.000    974.490    710.100      cvmsi   5132.631   2683.816   2723.680       none      0.000      0.000      0.000      crust   5132.631   2683.816   2723.680
 -118.4167    34.3489   3000.000    974.490    710.100      cvmsi   5715.153   3181.090   2709.527       none      0.000      0.000      0.000      crust   5715.153   3181.090   2709.527
 -118.4167    34.3489   5000.000    974.490    710.100      cvmsi   4472.802   2737.944   2428.076       none      0.000      0.000      0.000      crust   4472.802   2737.944   2428.076
 -118.4156    34.3498   1000.000   1057.359    710.100      cvmsi   5142.771   2692.012   2725.692       none      0.000      0.000      0.000      crust   5142.771   2692.012   2725.692
 -118.4156    34.3498   3000.000   1057.359    710.100      cvmsi   5711.416   3175.057   2710.819       none      0.000      0.000      0.000      crust   5711.416   3175.057   2710.819
 -118.4156    34.3498   5000.000   1057.359    710.100      cvmsi   4165.649   2535.695   2372.580       none      0.000      0.000      0.000      crust   4165.649   2535.695   2372.580
 -118.4148    34.3505   1000.000   1066.764    710.100      cvmsi   5149.933   2697.868   2727.149       none      0.000      0.000      0.000      crust   5149.933   2697.868   2727.149
 -118.4148    34.3505   3000.000   1066.764    710.100      cvmsi   5725.614   3182.927   2711.759       none      0.000      0.000      0.000      crust   5725.614   3182.927   2711.759
 -118.4148    34.3505   5000.000   1066.764    710.100      cvmsi   6194.514   3433.354   2696.369       none      0.000      0.000      0.000      crust   6194.514   3433.354   2696.369
EOF_EXPECTED_RESULT

echo "Running examples_programs_ucvm ucvm_query_cvmsi"
if diff $result $expect > /dev/null 2>&1
then
  echo [SUCCESS]
else
  echo [FAILURE]
fi

trap 'rm -f "$expect" "$result"' exit

