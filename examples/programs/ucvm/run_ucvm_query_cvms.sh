#!/bin/bash

if [ -z "$UCVM_INSTALL_PATH" ]; then
  echo "Need to set UCVM_INSTALL_PATH to run >" ${0##*/} 
  exit
fi
source $UCVM_INSTALL_PATH/conf/ucvm_env.sh

BIN_DIR=${UCVM_INSTALL_PATH}/bin
CONF_DIR=${UCVM_INSTALL_PATH}/conf
TEST_DIR=${UCVM_INSTALL_PATH}/tests/inputs
MODEL=cvms

expect=$(mktemp) || exit 1
result=$(mktemp) || (trap 'rm -f "$expect"'; exit 1)

${BIN_DIR}/ucvm_query -m ${MODEL} -f ${CONF_DIR}/ucvm.conf < ${TEST_DIR}/test_latlons_cvmsi.txt  > $result 2>&1

cat > $expect << EOF_EXPECTED_RESULT
Using Geo Depth coordinates as default mode.
 -118.4830    34.2940   1000.000    353.889    390.625       cvms   2551.305   1287.553   2267.851       none      0.000      0.000      0.000      crust   2551.305   1287.553   2267.851
 -118.4830    34.2940   3000.000    353.889    390.625       cvms   3437.276   1895.664   2407.746       none      0.000      0.000      0.000      crust   3437.276   1895.664   2407.746
 -118.4830    34.2940   5000.000    353.889    390.625       cvms   4349.042   2510.921   2551.714       none      0.000      0.000      0.000      crust   4349.042   2510.921   2551.714
 -118.4050    34.3580   1000.000    947.410    710.100       cvms   5574.587   2815.778   2745.227       none      0.000      0.000      0.000      crust   5574.587   2815.778   2745.227
 -118.4050    34.3580   3000.000    947.410    710.100       cvms   5435.818   2734.861   2723.316       none      0.000      0.000      0.000      crust   5435.818   2734.861   2723.316
 -118.4050    34.3580   5000.000    947.410    710.100       cvms   5297.050   2653.944   2701.404       none      0.000      0.000      0.000      crust   5297.050   2653.944   2701.404
 -118.4440    34.3260   1000.000    444.266    361.893       cvms   2512.409   1262.102   2261.709       none      0.000      0.000      0.000      crust   2512.409   1262.102   2261.709
 -118.4440    34.3260   3000.000    444.266    361.893       cvms   3062.269   1632.050   2348.532       none      0.000      0.000      0.000      crust   3062.269   1632.050   2348.532
 -118.4440    34.3260   5000.000    444.266    361.893       cvms   3504.778   1943.984   2418.405       none      0.000      0.000      0.000      crust   3504.778   1943.984   2418.405
 -118.4167    34.3489   1000.000    974.490    710.100       cvms   5438.123   2720.531   2723.680       none      0.000      0.000      0.000      crust   5438.123   2720.531   2723.680
 -118.4167    34.3489   3000.000    974.490    710.100       cvms   5348.490   2687.172   2709.527       none      0.000      0.000      0.000      crust   5348.490   2687.172   2709.527
 -118.4167    34.3489   5000.000    974.490    710.100       cvms   3566.032   1988.049   2428.076       none      0.000      0.000      0.000      crust   3566.032   1988.049   2428.076
 -118.4156    34.3498   1000.000   1057.359    710.100       cvms   5450.867   2729.476   2725.692       none      0.000      0.000      0.000      crust   5450.867   2729.476   2725.692
 -118.4156    34.3498   3000.000   1057.359    710.100       cvms   5356.674   2691.664   2710.819       none      0.000      0.000      0.000      crust   5356.674   2691.664   2710.819
 -118.4156    34.3498   5000.000   1057.359    710.100       cvms   3214.567   1738.090   2372.580       none      0.000      0.000      0.000      crust   3214.567   1738.090   2372.580
 -118.4148    34.3505   1000.000   1066.764    710.100       cvms   5460.098   2736.000   2727.149       none      0.000      0.000      0.000      crust   5460.098   2736.000   2727.149
 -118.4148    34.3505   3000.000   1066.764    710.100       cvms   5362.629   2694.954   2711.759       none      0.000      0.000      0.000      crust   5362.629   2694.954   2711.759
 -118.4148    34.3505   5000.000   1066.764    710.100       cvms   5265.160   2653.907   2696.369       none      0.000      0.000      0.000      crust   5265.160   2653.907   2696.369
EOF_EXPECTED_RESULT

echo "Running examples_programs_ucvm ucvm_query_cvms"
if diff $result $expect > /dev/null 2>&1
then
  echo [SUCCESS]
else
  echo [FAILURE]
fi

trap 'rm -f "$expect" "$result"' exit

