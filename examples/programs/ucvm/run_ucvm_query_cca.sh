#!/bin/bash

if [ -z "$UCVM_INSTALL_PATH" ]; then
  echo "Need to set UCVM_INSTALL_PATH to run >" ${0##*/} 
  exit
fi
source $UCVM_INSTALL_PATH/conf/ucvm_env.sh

BIN_DIR=${UCVM_INSTALL_PATH}/bin
CONF_DIR=${UCVM_INSTALL_PATH}/conf
TEST_DIR=${UCVM_INSTALL_PATH}/tests/inputs
MODEL=cca

expect=$(mktemp) || exit 1
result=$(mktemp) || (trap 'rm -f "$expect"'; exit 1)

${BIN_DIR}/ucvm_query -m ${MODEL} -f ${CONF_DIR}/ucvm.conf < ${TEST_DIR}/test_latlons.txt  > $result 2>&1
${BIN_DIR}/ucvm_query -m ${MODEL} -f ${CONF_DIR}/ucvm.conf < ${TEST_DIR}/test_latlons_cca_gd.txt  >> $result 2>&1

cat > $expect << EOF_EXPECTED_RESULT
Using Geo Depth coordinates as default mode.
 -118.0000    34.0000      0.000    284.191    580.043       none      0.000      0.000      0.000       none      0.000      0.000      0.000       none      0.000      0.000      0.000
 -118.0000    34.0000     50.000    284.191    580.043       none      0.000      0.000      0.000       none      0.000      0.000      0.000       none      0.000      0.000      0.000
 -118.0000    34.0000    100.000    284.191    580.043       none      0.000      0.000      0.000       none      0.000      0.000      0.000       none      0.000      0.000      0.000
 -118.0000    34.0000    500.000    284.191    580.043       none      0.000      0.000      0.000       none      0.000      0.000      0.000       none      0.000      0.000      0.000
 -118.0000    34.0000   1000.000    284.191    580.043       none      0.000      0.000      0.000       none      0.000      0.000      0.000       none      0.000      0.000      0.000
Using Geo Depth coordinates as default mode.
 -118.7950    36.4140      0.000   1798.774    710.100        cca   5374.303   3053.654   2544.007       none      0.000      0.000      0.000      crust   5374.303   3053.654   2544.007
 -118.7950    36.4140    500.000   1798.774    710.100        cca   5367.673   3049.543   2542.755       none      0.000      0.000      0.000      crust   5367.673   3049.543   2542.755
 -118.7950    36.4140   1000.000   1798.774    710.100        cca   5343.324   3034.676   2538.271       none      0.000      0.000      0.000      crust   5343.324   3034.676   2538.271
 -118.7950    36.4140   3000.000   1798.774    710.100        cca   5544.159   3171.007   2581.869       none      0.000      0.000      0.000      crust   5544.159   3171.007   2581.869
 -118.7950    36.4140   5000.000   1798.774    710.100        cca   5951.625   3467.630   2696.170       none      0.000      0.000      0.000      crust   5951.625   3467.630   2696.170
 -120.0850    37.2060      0.000    122.967    517.530        cca   4284.075   2472.753   2411.092       none      0.000      0.000      0.000      crust   4284.075   2472.753   2411.092
 -120.0850    37.2060    500.000    122.967    517.530        cca   4806.075   2792.233   2473.988       none      0.000      0.000      0.000      crust   4806.075   2792.233   2473.988
 -120.0850    37.2060   1000.000    122.967    517.530        cca   5104.055   2979.978   2522.348       none      0.000      0.000      0.000      crust   5104.055   2979.978   2522.348
 -120.0850    37.2060   3000.000    122.967    517.530        cca   5463.962   3128.765   2567.770       none      0.000      0.000      0.000      crust   5463.962   3128.765   2567.770
 -120.0850    37.2060   5000.000    122.967    517.530        cca   5524.818   3155.166   2576.524       none      0.000      0.000      0.000      crust   5524.818   3155.166   2576.524
 -121.4440    36.2370      0.000    239.454    385.100        cca   2728.506   1533.761   2267.914       none      0.000      0.000      0.000      crust   2728.506   1533.761   2267.914
 -121.4440    36.2370    500.000    239.454    385.100        cca   4109.579   2266.308   2379.668       none      0.000      0.000      0.000      crust   4109.579   2266.308   2379.668
 -121.4440    36.2370   1000.000    239.454    385.100        cca   4834.095   2869.375   2492.675       none      0.000      0.000      0.000      crust   4834.095   2869.375   2492.675
 -121.4440    36.2370   3000.000    239.454    385.100        cca   5827.523   3487.871   2704.919       none      0.000      0.000      0.000      crust   5827.523   3487.871   2704.919
 -121.4440    36.2370   5000.000    239.454    385.100        cca   5957.999   3561.834   2737.911       none      0.000      0.000      0.000      crust   5957.999   3561.834   2737.911
 -120.4870    34.2220      0.000   -252.000    180.000        cca   5102.440   2870.915   2493.066       none      0.000      0.000      0.000      crust   5102.440   2870.915   2493.066
 -120.4870    34.2220    500.000   -252.000    180.000        cca   5102.726   2870.835   2493.046       none      0.000      0.000      0.000      crust   5102.726   2870.835   2493.046
 -120.4870    34.2220   1000.000   -252.000    180.000        cca   5116.871   2878.825   2495.078       none      0.000      0.000      0.000      crust   5116.871   2878.825   2495.078
 -120.4870    34.2220   3000.000   -252.000    180.000        cca   5372.349   3039.409   2539.691       none      0.000      0.000      0.000      crust   5372.349   3039.409   2539.691
 -120.4870    34.2220   5000.000   -252.000    180.000        cca   5623.723   3172.936   2582.522       none      0.000      0.000      0.000      crust   5623.723   3172.936   2582.522
 -121.8143    36.6509      0.000     43.756    313.533        cca   2482.278   1417.920   2241.739       none      0.000      0.000      0.000      crust   2482.278   1417.920   2241.739
 -121.8143    36.6509    500.000     43.756    313.533        cca   2903.587   1658.217   2291.858       none      0.000      0.000      0.000      crust   2903.587   1658.217   2291.858
 -121.8143    36.6509   1000.000     43.756    313.533        cca   3489.203   2012.901   2345.362       none      0.000      0.000      0.000      crust   3489.203   2012.901   2345.362
 -121.8143    36.6509   3000.000     43.756    313.533        cca   5640.649   3387.413   2662.637       none      0.000      0.000      0.000      crust   5640.649   3387.413   2662.637
 -121.8143    36.6509   5000.000     43.756    313.533        cca   5890.742   3531.134   2724.029       none      0.000      0.000      0.000      crust   5890.742   3531.134   2724.029
EOF_EXPECTED_RESULT

echo "Running examples_programs_ucvm ucvm_query_cca"
if diff $result $expect > /dev/null 2>&1
then
  echo [SUCCESS]
else
  echo [FAILURE]
fi

trap 'rm -f "$expect" "$result"' exit

