#!/bin/bash

if [ -z "$UCVM_INSTALL_PATH" ]; then
  echo "Need to set UCVM_INSTALL_PATH to run >" ${0##*/} 
  exit
fi

BIN_DIR=${UCVM_INSTALL_PATH}/bin
CONF_DIR=${UCVM_INSTALL_PATH}/conf
SCRATCH=./scratch

sed 's ${CONF_DIR} '$CONF_DIR' ' small_cvmh.conf_template | sed 's ${SCRATCH} '$SCRATCH' ' > small_cvmh.conf

${BIN_DIR}/ucvm2mesh -f small_cvmh.conf > small_cvmh.out 2>& 1 

expect=$(mktemp) || exit 1
result=$(mktemp) || (trap 'rm -f "$expect"'; exit 1)

od small_cvmh.grid > $result 2>& 1

cat > $expect << EOF_EXPECTED_RESULT
0000000 023461 144414 037776 140136 074642 041450 000000 040100
0000020 000000 000000 000000 000000 142601 065260 037775 140136
0000040 042624 164265 177774 040077 000000 000000 000000 000000
0000060 077276 006125 037774 140136 050735 045431 177771 040077
0000100 000000 000000 000000 000000 051345 126772 037772 140136
0000120 014052 126575 177765 040077 000000 000000 000000 000000
0000140 040771 047637 037771 140136 114161 007740 177762 040077
0000160 000000 000000 000000 000000 045770 170504 037767 140136
0000200 151272 071103 177756 040077 000000 000000 000000 000000
0000220 151144 134577 037775 140136 011740 114107 000002 040100
0000240 000000 000000 000000 000000 063372 055444 037774 140136
0000260 023353 144571 000000 040100 000000 000000 000000 000000
0000300 013176 176311 037772 140136 026753 172526 177775 040077
0000320 000000 000000 000000 000000 160353 117155 037771 140136
0000340 143777 053671 177772 040077 000000 000000 000000 000000
0000360 143104 040022 037770 140136 016016 135035 177766 040077
0000400 000000 000000 000000 000000 143212 160667 037766 140136
0000420 025036 016200 177763 040077 000000 000000 000000 000000
0000440 061254 124763 037774 140136 120005 166545 000004 040100
0000460 000000 000000 000000 000000 166610 045627 037773 140136
0000500 116364 017227 000003 040100 000000 000000 000000 000000
0000520 111520 166474 037771 140136 073342 047711 000001 040100
0000540 000000 000000 000000 000000 052005 107341 037770 140136
0000560 055641 000766 177777 040077 000000 000000 000000 000000
0000600 027645 030206 037767 140136 101572 062131 177773 040077
0000620 000000 000000 000000 000000 023061 151053 037765 140136
0000640 062523 143274 177767 040077 000000 000000 000000 000000
0000660 154007 115146 037773 140136 017024 041204 000007 040100
0000700 000000 000000 000000 000000 054451 036013 037772 140136
0000720 002345 071666 000005 040100 000000 000000 000000 000000
0000740 172470 156657 037770 140136 144267 122347 000003 040100
0000760 000000 000000 000000 000000 126062 077524 037767 140136
0001000 064611 153031 000001 040100 000000 000000 000000 000000
0001020 077031 020371 037766 140136 163531 003512 000000 040100
0001040 000000 000000 000000 000000 065352 141236 037764 140136
0001060 102122 070370 177774 040077 000000 000000 000000 000000
0001100 031167 105332 037772 140136 107007 113642 000011 040100
0001120 000000 000000 000000 000000 124737 026176 037771 140136
0001140 057276 144324 000007 040100 000000 000000 000000 000000
0001160 036063 147043 037767 140136 006164 175006 000005 040100
0001200 000000 000000 000000 000000 164564 067707 037766 140136
0001220 113451 025467 000004 040100 000000 000000 000000 000000
0001240 130641 010554 037765 140136 177340 056150 000002 040100
0001260 000000 000000 000000 000000 112270 131421 037763 140136
0001300 041624 106632 000000 040100 000000 000000 000000 000000
0001320
EOF_EXPECTED_RESULT

echo "Running examples_programs_ucvm2mesh ucvm2mesh_cvmh"
if diff $result $expect > /dev/null 2>&1
then
  echo [SUCCESS]
else
  echo [FAILURE]
fi

trap 'rm -f "$expect" "$result"' exit


