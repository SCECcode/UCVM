#!/bin/bash

if [ -z "$UCVM_INSTALL_PATH" ]; then
  echo "Need to set UCVM_INSTALL_PATH to run >" ${0##*/} 
  exit
fi
source $UCVM_INSTALL_PATH/conf/ucvm_env.sh

BIN_DIR=${UCVM_INSTALL_PATH}/bin
CONF_DIR=${UCVM_INSTALL_PATH}/conf
SCRATCH=./scratch

sed 's ${CONF_DIR} '$CONF_DIR' ' southbay_cca.conf_template | sed 's ${SCRATCH} '$SCRATCH' ' > southbay_cca.conf

${BIN_DIR}/ucvm2mesh -f southbay_cca.conf > southbay_cca.out 2>& 1 

expect=$(mktemp) || exit 1
result=$(mktemp) || (trap 'rm -f "$expect"'; exit 1)

od southbay_cca.grid | head -20 > $result 2>& 1

cat > $expect << EOF_EXPECTED_RESULT
0000000 162234 136645 072645 140136 005021 072140 120154 040102
0000020 000000 000000 000000 000000 106156 167615 072642 140136
0000040 047635 116104 120150 040102 000000 000000 000000 000000
0000060 143264 020565 072640 140136 010301 142050 120144 040102
0000100 000000 000000 000000 000000 111560 051536 072635 140136
0000120 046574 166013 120140 040102 000000 000000 000000 000000
0000140 171242 102507 072632 140136 002720 011756 120135 040102
0000160 000000 000000 000000 000000 162111 133461 072627 140136
0000200 034675 035720 120131 040102 000000 000000 000000 000000
0000220 064143 164434 072624 140136 164477 061661 120125 040102
0000240 000000 000000 000000 000000 077364 015407 072622 140136
0000260 012136 105623 120121 040102 000000 000000 000000 000000
0000300 023770 046363 072617 140136 135425 131563 120115 040102
0000320 000000 000000 000000 000000 061561 077337 072614 140136
0000340 156550 155523 120111 040102 000000 000000 000000 000000
0000360 030537 130314 072611 140136 075526 001463 120106 040102
0000400 000000 000000 000000 000000 110700 161271 072606 140136
0000420 112334 025422 120102 040102 000000 000000 000000 000000
0000440 102226 012247 072604 140136 024777 051361 120076 040102
0000460 000000 000000 000000 000000 004737 043226 072601 140136
EOF_EXPECTED_RESULT

echo "Running examples_programs_ucvm2mesh ucvm2mesh_cca"
if diff $result $expect > /dev/null 2>&1
then
  echo [SUCCESS]
else
  echo [FAILURE]
fi

trap 'rm -f "$expect" "$result"' exit


