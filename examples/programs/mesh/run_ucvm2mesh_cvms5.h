#!/bin/bash

if [ -z "$UCVM_INSTALL_PATH" ]; then
  echo "Need to set UCVM_INSTALL_PATH to run >" ${0##*/} 
  exit
fi
source $UCVM_INSTALL_PATH/conf/ucvm_env.sh

BIN_DIR=${UCVM_INSTALL_PATH}/bin
CONF_DIR=${UCVM_INSTALL_PATH}/conf
SCRATCH=./scratch

sed 's ${CONF_DIR} '$CONF_DIR' ' small_cvms5.conf_template | sed 's ${SCRATCH} '$SCRATCH' ' > small_cvms5.conf

${BIN_DIR}/ucvm2mesh -f small_cvms5.conf > small_cvms5.out 2>& 1 

expect=$(mktemp) || exit 1
result=$(mktemp) || (trap 'rm -f "$expect"'; exit 1)

od small_cvms5.grid | sed 's/ //g' > $result 2>& 1

cat > $expect << EOF_EXPECTED_RESULT
0000000105124136723137776140135032755120210063146040101
0000020000000000000000000000000112422054152137775140135
0000040063470143447063144040101000000000000000000000000
0000060137567171401137773140135072475166706063142040101
0000100000000000000000000000000004604106631137772140135
0000120057770012145063141040101000000000000000000000000
0000140071471024060137771140135023555035404063137040101
0000160000000000000000000000000176226141307137767140135
0000200145631060642063135040101000000000000000000000000
0000220110016117343137775140135066754167054063150040101
0000240000000000000000000000000111145034572137774140135
0000260102657012313063147040101000000000000000000000000
0000300132144152021137772140135075051035552063145040101
0000320000000000000000000000000173014067250137771140135
0000340045536061011063143040101000000000000000000000000
0000360053535004500137770140135174512104247063141040101
0000400000000000000000000000000154125121727137766140135
0000420101755127506063137040101000000000000000000000000
0000440073036077763137774140135111204035720063153040101
0000460000000000000000000000000070020015212137773140135
0000500110277061157063151040101000000000000000000000000
0000520104653132441137771140135065662104416063147040101
0000540000000000000000000000000141355047670137770140135
0000560021534127655063145040101000000000000000000000000
0000600015731165120137766140135133701153113063143040101
0000620000000000000000000000000112152102347137765140135
0000640024334176352063141040101000000000000000000000000
0000660036206060403137773140135121667104564063155040101
0000700000000000000000000000000027024175632137771140135
0000720104151130023063153040101000000000000000000000000
0000740037510113061137770140135044723153262063151040101
0000760000000000000000000000000070045030310137767140135
0001000163765176520063147040101000000000000000000000000
0001020140253145537137765140135061320021757063146040101
0001040000000000000000000000000030332062767137764140135
0001060135142045215063144040101000000000000000000000000
0001100161506041022137772140135120610153430063157040101
0001120000000000000000000000000146156156251137770140135
0001140066257176667063155040101000000000000000000000000
0001160152475073500137767140135012220022126063154040101
0001200000000000000000000000000176666010727137766140135
0001220114452045364063152040101000000000000000000000000
0001240042727126157137764140135175174070622063150040101
0001260000000000000000000000000126640043406137763140135
0001300034206114061063146040101000000000000000000000000
0001320
EOF_EXPECTED_RESULT

echo "Running examples_programs_ucvm2mesh ucvm2mesh_cvms5"
if diff $result $expect > /dev/null 2>&1
then
  echo [SUCCESS]
else
  echo [FAILURE]
fi

trap 'rm -f "$expect" "$result"' exit


