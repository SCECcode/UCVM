#!/bin/bash

if [ -z "$UCVM_INSTALL_PATH" ]; then
  echo "Need to set UCVM_INSTALL_PATH to run >" ${0##*/} 
  exit
fi
source $UCVM_INSTALL_PATH/conf/ucvm_env.sh

BIN_DIR=${UCVM_INSTALL_PATH}/bin
CONF_DIR=${UCVM_INSTALL_PATH}/conf
SCRATCH=./scratch

sed 's ${CONF_DIR} '$CONF_DIR' ' southbay_sfcvm.conf_template | sed 's ${SCRATCH} '$SCRATCH' ' > southbay_sfcvm.conf

${BIN_DIR}/ucvm2mesh -f southbay_sfcvm.conf > southbay_sfcvm.out 2>& 1 

expect=$(mktemp) || exit 1
result=$(mktemp) || (trap 'rm -f "$expect"'; exit 1)

od southbay_sfcvm.grid | head -20 > $result 2>& 1

cat > $expect << EOF_EXPECTED_RESULT
0000000 017736 005173 105357 140136 176613 022332 162547 040102
0000020 000000 000000 000000 000000 005011 032414 105354 140136
0000040 106166 050260 162543 040102 000000 000000 000000 000000
0000060 105122 057635 105351 140136 111016 076205 162537 040102
0000100 000000 000000 000000 000000 120270 105057 105346 140136
0000120 007116 124132 162533 040102 000000 000000 000000 000000
0000140 046471 132302 105343 140136 000467 152056 162527 040102
0000160 000000 000000 000000 000000 107732 157525 105340 140136
0000200 065314 000001 162524 040102 000000 000000 000000 000000
0000220 064226 004751 105336 140136 045410 025724 162520 040102
0000240 000000 000000 000000 000000 153560 032175 105333 140136
0000260 120761 053646 162514 040102 000000 000000 000000 000000
0000300 156145 057422 105330 140136 067604 101570 162510 040102
0000320 000000 000000 000000 000000 073567 104650 105325 140136
0000340 131703 127511 162504 040102 000000 000000 000000 000000
0000360 124245 132076 105322 140136 067257 155432 162500 040102
0000400 000000 000000 000000 000000 067757 157325 105317 140136
0000420 120107 003352 162475 040102 000000 000000 000000 000000
0000440 146524 004554 105315 140136 044213 031272 162471 040102
0000460 000000 000000 000000 000000 140325 032004 105312 140136
EOF_EXPECTED_RESULT

echo "Running examples_programs_ucvm2mesh ucvm2mesh_sfcvm"
if diff $result $expect > /dev/null 2>&1
then
  echo [SUCCESS]
else
  echo [FAILURE]
fi

trap 'rm -f "$expect" "$result"' exit


